<!-- Organization Tab -->
<div id="organization" class="tab-content">
    <div class="org-header" style="margin-bottom:1.5rem;">
        <h2>Agent Network</h2>
        <div class="org-actions">
            <button class="btn" onclick="addNewAgentNode()">+ Add Agent</button>
            <button class="btn" onclick="saveNodeLayout()">üíæ Save Layout</button>
            <select id="view-mode" class="btn" onchange="switchViewMode()">
                <option value="flow">Flow View</option>
                <option value="hierarchy">Hierarchy View</option>
            </select>
        </div>
    </div>
    
    <div class="node-canvas-container">
        <div class="canvas-toolbar">
            <div class="tool-group">
                <button class="btn btn-sm" onclick="zoomIn()">üîç+</button>
                <button class="btn btn-sm" onclick="zoomOut()">üîç-</button>
                <button class="btn btn-sm" onclick="resetZoom()">Reset</button>
            </div>
            <div class="tool-group">
                <button class="btn btn-sm" onclick="autoLayout()">Auto Layout</button>
                <button class="btn btn-sm" onclick="toggleMinimap()">Minimap</button>
            </div>
        </div>

        <div id="node-canvas" class="node-canvas">
            <!-- CEO Node -->
            <div class="workflow-node ceo" draggable="true" data-node-id="ceo">
                <div class="node-header">
                    <div class="node-icon">üëë</div>
                    <div class="node-title">CEO</div>
                    <div class="node-status active"></div>
                </div>
                <div class="node-body">
                    <div class="node-avatar">
                        <img src="https://ui-avatars.com/api/?name=Ayoub&background=6d28d9&color=fff" alt="Ayoub">
                    </div>
                    <div class="node-info">
                        <h4>Ayoub</h4>
                        <p>Vision & Strategy</p>
                    </div>
                </div>
                <div class="node-ports">
                    <div class="port output" data-port-id="ceo-out"></div>
                </div>
            </div>

            <!-- AssetLink Node -->
            <div class="workflow-node ai" draggable="true" data-node-id="assetlink">
                <div class="node-header">
                    <div class="node-icon">ü§ñ</div>
                    <div class="node-title">Core AI</div>
                    <div class="node-actions">
                        <button class="btn-icon" onclick="toggleNodeExpand(event, 'assetlink')">‚ñº</button>
                        <div class="node-status active"></div>
                    </div>
                </div>
                <div class="node-body">
                    <div class="node-avatar">
                        <img src="https://ui-avatars.com/api/?name=AL&background=2563eb&color=fff" alt="AssetLink">
                    </div>
                    <div class="node-info">
                        <h4>AssetLink</h4>
                        <p>Claude 3.5 | Opus 4.6</p>
                    </div>
                </div>

                <div class="node-ports">
                    <div class="port input" data-port-id="al-in">
                        <span class="port-label">Input</span>
                    </div>
                    <div class="port output" data-port-id="al-out">
                        <span class="port-label">Output</span>
                    </div>
                </div>

                <div class="node-details">
                    <div class="detail-section">
                        <div class="section-header" onclick="toggleSection(event, 'tools')">
                            <span class="section-title">üõ†Ô∏è Tools (15)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="section-content tools-grid">
                            <div class="tool-item">
                                <span class="tool-icon">üìù</span>
                                <div class="tool-info">
                                    <span class="tool-name">read</span>
                                    <span class="tool-type">File System</span>
                                </div>
                            </div>
                            <div class="tool-item">
                                <span class="tool-icon">üíæ</span>
                                <div class="tool-info">
                                    <span class="tool-name">write</span>
                                    <span class="tool-type">File System</span>
                                </div>
                            </div>
                            <div class="tool-item">
                                <span class="tool-icon">üåê</span>
                                <div class="tool-info">
                                    <span class="tool-name">browser</span>
                                    <span class="tool-type">Automation</span>
                                </div>
                            </div>
                            <div class="tool-item">
                                <span class="tool-icon">‚ö°</span>
                                <div class="tool-info">
                                    <span class="tool-name">exec</span>
                                    <span class="tool-type">System</span>
                                </div>
                            </div>
                            <div class="tool-item">
                                <span class="tool-icon">üí¨</span>
                                <div class="tool-info">
                                    <span class="tool-name">message</span>
                                    <span class="tool-type">Communication</span>
                                </div>
                            </div>
                            <button class="show-more" onclick="showAllTools(event)">Show All Tools...</button>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="section-header" onclick="toggleSection(event, 'skills')">
                            <span class="section-title">üìö Skills (8)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="section-content skills-grid">
                            <div class="skill-item">
                                <span class="skill-icon">ü§ñ</span>
                                <div class="skill-info">
                                    <span class="skill-name">Agent Browser</span>
                                    <span class="skill-type automation">Automation</span>
                                </div>
                            </div>
                            <div class="skill-item">
                                <span class="skill-icon">‚òÅÔ∏è</span>
                                <div class="skill-info">
                                    <span class="skill-name">Weather</span>
                                    <span class="skill-type api">API</span>
                                </div>
                            </div>
                            <div class="skill-item">
                                <span class="skill-icon">üé®</span>
                                <div class="skill-info">
                                    <span class="skill-name">Image Generation</span>
                                    <span class="skill-type creative">Creative</span>
                                </div>
                            </div>
                            <div class="skill-item">
                                <span class="skill-icon">üîä</span>
                                <div class="skill-info">
                                    <span class="skill-name">Whisper API</span>
                                    <span class="skill-type api">API</span>
                                </div>
                            </div>
                            <button class="show-more" onclick="showAllSkills(event)">Show All Skills...</button>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="section-header" onclick="toggleSection(event, 'files')">
                            <span class="section-title">üìÅ Files (12)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="section-content files-list">
                            <div class="file-item">
                                <span class="file-icon">üìÑ</span>
                                <span class="file-name">AGENTS.md</span>
                                <button class="btn-xs" onclick="viewFile('AGENTS.md', event)">View</button>
                            </div>
                            <div class="file-item">
                                <span class="file-icon">üìÑ</span>
                                <span class="file-name">MEMORY.md</span>
                                <button class="btn-xs" onclick="viewFile('MEMORY.md', event)">View</button>
                            </div>
                            <div class="file-item">
                                <span class="file-icon">üìÑ</span>
                                <span class="file-name">SOUL.md</span>
                                <button class="btn-xs" onclick="viewFile('SOUL.md', event)">View</button>
                            </div>
                            <button class="show-more" onclick="showAllFiles(event)">Show All Files...</button>
                        </div>
                    </div>
                </div>

                <div class="node-metrics">
                    <div class="metric-group">
                        <span class="metric-label">Status</span>
                        <span class="metric-value success">Active</span>
                    </div>
                    <div class="metric-group">
                        <span class="metric-label">Memory</span>
                        <span class="metric-value">25%</span>
                    </div>
                    <div class="metric-group">
                        <span class="metric-label">Tasks</span>
                        <span class="metric-value">3</span>
                    </div>
                </div>
            </div>

            <!-- Add Agent Node -->
            <div class="workflow-node agent placeholder" onclick="showAddAgentModal()">
                <div class="node-header">
                    <div class="node-icon">+</div>
                    <div class="node-title">Add New Agent</div>
                </div>
                <div class="node-info">
                    <p>Click to create a new AI agent</p>
                </div>
            </div>

            <!-- Connection Lines -->
            <svg class="connections-layer" style="pointer-events:none;">
                <!-- Connections drawn via JavaScript -->
            </svg>
        </div>

        <!-- Minimap -->
        <div id="minimap" class="minimap"></div>
    </div>

    <!-- Node Context Menu -->
    <div id="node-context-menu" class="context-menu" style="display:none;">
        <div class="menu-item" onclick="expandNode()">
            <span class="icon">üìã</span>
            <span>View Details</span>
        </div>
        <div class="menu-item" onclick="editNode()">
            <span class="icon">‚úèÔ∏è</span>
            <span>Edit</span>
        </div>
        <div class="menu-item" onclick="viewNodeFiles()">
            <span class="icon">üìÅ</span>
            <span>View Files</span>
        </div>
        <div class="menu-separator"></div>
        <div class="menu-item warning" onclick="deleteNode()">
            <span class="icon">üóëÔ∏è</span>
            <span>Delete</span>
        </div>
    </div>

    <style>
    .node-canvas-container {
        position: relative;
        height: calc(100vh - 200px);
        background: var(--bg-subtle);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
    }

    .canvas-toolbar {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 1rem;
        z-index: 10;
    }

    .tool-group {
        display: flex;
        gap: 0.5rem;
        background: var(--surface);
        padding: 0.5rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
    }

    .node-canvas {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: auto;
        padding: 2rem;
    }

    .workflow-node {
        position: absolute;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        min-width: 250px;
        cursor: move;
        box-shadow: var(--shadow-md);
        transition: all 0.2s ease;
    }

    .workflow-node:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .workflow-node.ceo {
        background: linear-gradient(135deg, var(--purple-glow), var(--surface));
        border-color: var(--purple);
    }

    .workflow-node.ai {
        background: linear-gradient(135deg, var(--accent-glow2), var(--surface));
        border-color: var(--accent);
    }

    .workflow-node.expanded {
        width: 400px;
        z-index: 100;
    }

    .node-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .node-icon {
        font-size: 1.2rem;
    }

    .node-title {
        flex: 1;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .node-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-dim);
    }

    .node-status.active {
        background: var(--success);
        box-shadow: 0 0 10px var(--success-glow);
    }

    .node-body {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .node-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        overflow: hidden;
    }

    .node-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .node-info h4 {
        margin: 0;
        font-size: 1rem;
    }

    .node-info p {
        margin: 0.25rem 0 0;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .node-ports {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .port {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        cursor: crosshair;
        transition: all 0.2s;
    }

    .port:hover {
        transform: scale(1.2);
        box-shadow: 0 0 10px var(--accent-glow);
    }

    .port.input {
        background: var(--purple);
    }

    .port.output {
        background: var(--accent);
    }

    .port-label {
        font-size: 0.7rem;
        color: var(--text-dim);
    }

    .input .port-label {
        margin-left: 1rem;
    }

    .output .port-label {
        margin-right: 1rem;
        order: -1;
    }

    .node-details {
        display: none;
        margin-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .workflow-node.expanded .node-details {
        display: block;
    }

    .detail-section {
        margin-top: 1rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        cursor: pointer;
    }

    .section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .toggle-icon {
        font-size: 0.7rem;
        color: var(--text-dim);
        transition: transform 0.3s;
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        overflow: hidden;
        transition: max-height 0.3s;
    }

    .section-header.collapsed + .section-content {
        max-height: 0;
    }

    .tools-grid, .skills-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        padding: 0.5rem 0;
    }

    .tool-item, .skill-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-subtle);
        border-radius: var(--radius-xs);
        font-size: 0.8rem;
    }

    .tool-icon, .skill-icon {
        font-size: 1.1rem;
    }

    .tool-info, .skill-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .tool-name, .skill-name {
        color: var(--text);
    }

    .tool-type, .skill-type {
        font-size: 0.7rem;
        padding: 0.1rem 0.5rem;
        border-radius: 10px;
        background: var(--surface-active);
        color: var(--text-muted);
    }

    .skill-type.automation { color: var(--warning); }
    .skill-type.api { color: var(--success); }
    .skill-type.creative { color: var(--purple); }

    .files-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem 0;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-subtle);
        border-radius: var(--radius-xs);
        font-size: 0.8rem;
    }

    .file-name {
        flex: 1;
    }

    .btn-xs {
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
    }

    .show-more {
        grid-column: 1 / -1;
        text-align: center;
        padding: 0.5rem;
        background: var(--surface);
        border: 1px dashed var(--border);
        border-radius: var(--radius-xs);
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: pointer;
    }

    .show-more:hover {
        background: var(--surface-hover);
        border-color: var(--border-hover);
    }

    .node-metrics {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .metric-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .metric-label {
        font-size: 0.7rem;
        color: var(--text-dim);
    }

    .metric-value {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .metric-value.success { color: var(--success); }

    .connections-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .connection {
        fill: none;
        stroke: var(--accent);
        stroke-width: 2;
        opacity: 0.5;
    }

    .minimap {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        width: 200px;
        height: 150px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .minimap:hover {
        opacity: 1;
    }

    .context-menu {
        position: fixed;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 0.5rem;
        min-width: 150px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: var(--radius-xs);
        font-size: 0.85rem;
    }

    .menu-item:hover {
        background: var(--surface-hover);
    }

    .menu-item.warning {
        color: var(--danger);
    }

    .menu-separator {
        height: 1px;
        background: var(--border);
        margin: 0.5rem 0;
    }

    .menu-item .icon {
        font-size: 1.1rem;
    }
    </style>
</div>

<script>
// Node Management
let nodes = new Map();
let connections = new Set();
let draggedNode = null;
let dragOffset = { x: 0, y: 0 };
let scale = 1;
let pan = { x: 0, y: 0 };

// Initialize nodes
function initNodes() {
    const canvas = document.getElementById('node-canvas');
    const nodeElements = canvas.getElementsByClassName('workflow-node');

    // Position nodes
    nodeElements[0].style.left = '100px';  // CEO
    nodeElements[0].style.top = '50px';
    nodeElements[1].style.left = '100px';  // AssetLink
    nodeElements[1].style.top = '250px';
    nodeElements[2].style.left = '400px';  // Add Agent placeholder
    nodeElements[2].style.top = '250px';

    // Setup drag handlers
    Array.from(nodeElements).forEach(node => {
        node.addEventListener('dragstart', handleDragStart);
        node.addEventListener('drag', handleDrag);
        node.addEventListener('dragend', handleDragEnd);
    });

    // Initial connections
    updateConnections();
}

// Drag handlers
function handleDragStart(e) {
    draggedNode = e.target;
    const rect = draggedNode.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    draggedNode.style.opacity = '0.5';
}

function handleDrag(e) {
    if (!e.clientX || !draggedNode) return;
    
    const canvas = document.getElementById('node-canvas');
    const rect = canvas.getBoundingClientRect();
    
    let x = e.clientX - rect.left - dragOffset.x;
    let y = e.clientY - rect.top - dragOffset.y;
    
    // Constrain to canvas
    x = Math.max(0, Math.min(x, rect.width - draggedNode.offsetWidth));
    y = Math.max(0, Math.min(y, rect.height - draggedNode.offsetHeight));
    
    draggedNode.style.left = x + 'px';
    draggedNode.style.top = y + 'px';
    
    updateConnections();
}

function handleDragEnd() {
    if (!draggedNode) return;
    draggedNode.style.opacity = '1';
    draggedNode = null;
    updateConnections();
}

// Node expansion
function toggleNodeExpand(event, nodeId) {
    event.stopPropagation();
    const node = document.querySelector(`[data-node-id="${nodeId}"]`);
    const wasExpanded = node.classList.contains('expanded');
    
    // First collapse all nodes
    document.querySelectorAll('.workflow-node').forEach(n => {
        n.classList.remove('expanded');
        n.style.zIndex = '1';
    });
    
    // Then expand this one if it wasn't expanded
    if (!wasExpanded) {
        node.classList.add('expanded');
        node.style.zIndex = '100';  // Bring to front
    }
    
    updateConnections();
}

// Section toggling
function toggleSection(event, sectionType) {
    event.stopPropagation();
    const header = event.currentTarget;
    header.classList.toggle('collapsed');
}

// Connection management
function updateConnections() {
    const svg = document.querySelector('.connections-layer');
    svg.innerHTML = ''; // Clear existing connections
    
    // Define connections
    const connections = [
        { from: 'ceo-out', to: 'al-in' }
    ];
    
    connections.forEach(conn => {
        const fromPort = document.querySelector(`[data-port-id="${conn.from}"]`);
        const toPort = document.querySelector(`[data-port-id="${conn.to}"]`);
        
        if (fromPort && toPort) {
            const fromRect = fromPort.getBoundingClientRect();
            const toRect = toPort.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();
            
            const from = {
                x: fromRect.left + fromRect.width/2 - svgRect.left,
                y: fromRect.top + fromRect.height/2 - svgRect.top
            };
            
            const to = {
                x: toRect.left + toRect.width/2 - svgRect.left,
                y: toRect.top + toRect.height/2 - svgRect.top
            };
            
            // Create bezier curve
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const ctrl1 = { x: from.x + (to.x - from.x)/2, y: from.y };
            const ctrl2 = { x: from.x + (to.x - from.x)/2, y: to.y };
            
            path.setAttribute('d', `M${from.x},${from.y} C${ctrl1.x},${ctrl1.y} ${ctrl2.x},${ctrl2.y} ${to.x},${to.y}`);
            path.setAttribute('class', 'connection');
            
            svg.appendChild(path);
        }
    });
}

// View controls
function zoomIn() {
    scale = Math.min(scale * 1.2, 2);
    applyTransform();
}

function zoomOut() {
    scale = Math.max(scale / 1.2, 0.5);
    applyTransform();
}

function resetZoom() {
    scale = 1;
    pan = { x: 0, y: 0 };
    applyTransform();
}

function applyTransform() {
    const canvas = document.getElementById('node-canvas');
    canvas.style.transform = `scale(${scale}) translate(${pan.x}px, ${pan.y}px)`;
    updateConnections();
}

// Modal handlers
function showAllTools(event) {
    event.stopPropagation();
    // Show tools modal
}

function showAllSkills(event) {
    event.stopPropagation();
    // Show skills modal
}

function showAllFiles(event) {
    event.stopPropagation();
    // Show files modal
}

function viewFile(filename, event) {
    event.stopPropagation();
    // View file in editor
}

function showAddAgentModal() {
    // Show add agent modal
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initNodes);

// Update connections on window resize
window.addEventListener('resize', updateConnections);
</script>